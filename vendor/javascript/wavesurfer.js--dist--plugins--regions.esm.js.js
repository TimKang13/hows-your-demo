// wavesurfer.js/dist/plugins/regions.esm.js@7.12.1 downloaded from https://ga.jspm.io/npm:wavesurfer.js@7.12.1/dist/plugins/regions.esm.js

class t{constructor(){this.listeners={}}on(i,n,s){if(this.listeners[i]||(this.listeners[i]=new Set),null==s?void 0:s.once){const s=(...r)=>{this.un(i,s),n(...r)};return this.listeners[i].add(s),()=>this.un(i,s)}return this.listeners[i].add(n),()=>this.un(i,n)}un(i,n){var s;null===(s=this.listeners[i])||void 0===s||s.delete(n)}once(i,n){return this.on(i,n,{once:!0})}unAll(){this.listeners={}}emit(i,...n){this.listeners[i]&&this.listeners[i].forEach((i=>i(...n)))}}class e extends t{constructor(i){super(),this.subscriptions=[],this.isDestroyed=!1,this.options=i}onInit(){}_init(i){this.isDestroyed&&(this.subscriptions=[],this.isDestroyed=!1),this.wavesurfer=i,this.onInit()}destroy(){this.emit("destroy"),this.subscriptions.forEach((i=>i())),this.subscriptions=[],this.isDestroyed=!0,this.wavesurfer=void 0}}function i(n,s){const r=s.xmlns?document.createElementNS(s.xmlns,n):document.createElement(n);for(const[n,o]of Object.entries(s))if("children"===n&&o)for(const[n,s]of Object.entries(o))s instanceof Node?r.appendChild(s):"string"==typeof s?r.appendChild(document.createTextNode(s)):r.appendChild(i(n,s));else"style"===n?Object.assign(r.style,o):"textContent"===n?r.textContent=o:r.setAttribute(n,o.toString());return r}function n(n,s,r){const o=i(n,s||{});return null==r||r.appendChild(o),o}function s(i){let n=i;const s=new Set;return{get value(){return n},set(i){Object.is(n,i)||(n=i,s.forEach((i=>i(n))))},update(i){this.set(i(n))},subscribe:i=>(s.add(i),()=>s.delete(i))}}function r(i,n){let s;const r=()=>{s&&(s(),s=void 0),s=i()},o=n.map((i=>i.subscribe(r)));return r(),()=>{s&&(s(),s=void 0),o.forEach((i=>i()))}}function o(i,n){const r=s(null),o=i=>{r.set(i)};return i.addEventListener(n,o),r._cleanup=()=>{i.removeEventListener(n,o)},r}function l(i){const n=i._cleanup;"function"==typeof n&&n()}function h(i,n={}){const{threshold:r=3,mouseButton:o=0,touchDelay:h=100}=n,c=s(null),u=new Map,v=matchMedia("(pointer: coarse)").matches;let p=()=>{};const g=n=>{if(n.button!==o)return;if(u.set(n.pointerId,n),u.size>1)return;let s=n.clientX,l=n.clientY,g=!1;const m=Date.now(),f=i.getBoundingClientRect(),{left:b,top:E}=f,C=i=>{if(i.defaultPrevented||u.size>1)return;if(v&&Date.now()-m<h)return;const n=i.clientX,o=i.clientY,p=n-s,f=o-l;(g||Math.abs(p)>r||Math.abs(f)>r)&&(i.preventDefault(),i.stopPropagation(),g||(c.set({type:"start",x:s-b,y:l-E}),g=!0),c.set({type:"move",x:n-b,y:o-E,deltaX:p,deltaY:f}),s=n,l=o)},L=i=>{if(u.delete(i.pointerId),g){const n=i.clientX,s=i.clientY;c.set({type:"end",x:n-b,y:s-E})}p()},y=i=>{u.delete(i.pointerId),i.relatedTarget&&i.relatedTarget!==document.documentElement||L(i)},z=i=>{g&&(i.stopPropagation(),i.preventDefault())},w=i=>{i.defaultPrevented||u.size>1||g&&i.preventDefault()};document.addEventListener("pointermove",C),document.addEventListener("pointerup",L),document.addEventListener("pointerout",y),document.addEventListener("pointercancel",y),document.addEventListener("touchmove",w,{passive:!1}),document.addEventListener("click",z,{capture:!0}),p=()=>{document.removeEventListener("pointermove",C),document.removeEventListener("pointerup",L),document.removeEventListener("pointerout",y),document.removeEventListener("pointercancel",y),document.removeEventListener("touchmove",w),setTimeout((()=>{document.removeEventListener("click",z,{capture:!0})}),10)}};i.addEventListener("pointerdown",g);return{signal:c,cleanup:()=>{p(),i.removeEventListener("pointerdown",g),u.clear(),l(c)}}}class a extends t{constructor(i,n,s=0){var r,o,l,h,c,u,v,p,g,m;super(),this.totalDuration=n,this.numberOfChannels=s,this.element=null,this.minLength=0,this.maxLength=1/0,this.contentEditable=!1,this.subscriptions=[],this.updatingSide=void 0,this.isRemoved=!1,this.subscriptions=[],this.id=i.id||`region-${Math.random().toString(32).slice(2)}`,this.start=this.clampPosition(i.start),this.end=this.clampPosition(null!==(r=i.end)&&void 0!==r?r:i.start),this.drag=null===(o=i.drag)||void 0===o||o,this.resize=null===(l=i.resize)||void 0===l||l,this.resizeStart=null===(h=i.resizeStart)||void 0===h||h,this.resizeEnd=null===(c=i.resizeEnd)||void 0===c||c,this.color=null!==(u=i.color)&&void 0!==u?u:"rgba(0, 0, 0, 0.1)",this.minLength=null!==(v=i.minLength)&&void 0!==v?v:this.minLength,this.maxLength=null!==(p=i.maxLength)&&void 0!==p?p:this.maxLength,this.channelIdx=null!==(g=i.channelIdx)&&void 0!==g?g:-1,this.contentEditable=null!==(m=i.contentEditable)&&void 0!==m?m:this.contentEditable,this.element=this.initElement(),this.setContent(i.content),this.setPart(),this.renderPosition(),this.initMouseEvents()}clampPosition(i){return Math.max(0,Math.min(this.totalDuration,i))}setPart(){var i;const n=this.start===this.end;null===(i=this.element)||void 0===i||i.setAttribute("part",`${n?"marker":"region"} ${this.id}`)}addResizeHandles(i){const s={position:"absolute",zIndex:"2",width:"6px",height:"100%",top:"0",cursor:"ew-resize",wordBreak:"keep-all"},o=n("div",{part:"region-handle region-handle-left",style:Object.assign(Object.assign({},s),{left:"0",borderLeft:"2px solid rgba(0, 0, 0, 0.5)",borderRadius:"2px 0 0 2px"})},i),l=n("div",{part:"region-handle region-handle-right",style:Object.assign(Object.assign({},s),{right:"0",borderRight:"2px solid rgba(0, 0, 0, 0.5)",borderRadius:"0 2px 2px 0"})},i),c=h(o,{threshold:1}),u=h(l,{threshold:1}),v=r((()=>{const i=c.signal.value;i&&("move"===i.type&&void 0!==i.deltaX?this.onResize(i.deltaX,"start"):"end"===i.type&&this.onEndResizing("start"))}),[c.signal]),p=r((()=>{const i=u.signal.value;i&&("move"===i.type&&void 0!==i.deltaX?this.onResize(i.deltaX,"end"):"end"===i.type&&this.onEndResizing("end"))}),[u.signal]);this.subscriptions.push((()=>{v(),p(),c.cleanup(),u.cleanup()}))}removeResizeHandles(i){const n=i.querySelector('[part*="region-handle-left"]'),s=i.querySelector('[part*="region-handle-right"]');n&&i.removeChild(n),s&&i.removeChild(s)}initElement(){if(this.isRemoved)return null;const i=this.start===this.end;let s=0,r=100;this.channelIdx>=0&&this.numberOfChannels>0&&this.channelIdx<this.numberOfChannels&&(r=100/this.numberOfChannels,s=r*this.channelIdx);const o=n("div",{style:{position:"absolute",top:`${s}%`,height:`${r}%`,backgroundColor:i?"none":this.color,borderLeft:i?"2px solid "+this.color:"none",borderRadius:"2px",boxSizing:"border-box",transition:"background-color 0.2s ease",cursor:this.drag?"grab":"default",pointerEvents:"all"}});return!i&&this.resize&&this.addResizeHandles(o),o}renderPosition(){if(!this.element)return;const i=this.start/this.totalDuration,n=(this.totalDuration-this.end)/this.totalDuration;this.element.style.left=100*i+"%",this.element.style.right=100*n+"%"}toggleCursor(i){var n;this.drag&&(null===(n=this.element)||void 0===n?void 0:n.style)&&(this.element.style.cursor=i?"grabbing":"grab")}initMouseEvents(){const{element:i}=this;if(!i)return;const n=o(i,"click"),s=o(i,"mouseenter"),c=o(i,"mouseleave"),u=o(i,"dblclick"),v=o(i,"pointerdown"),p=o(i,"pointerup"),g=n.subscribe((i=>i&&this.emit("click",i))),m=s.subscribe((i=>i&&this.emit("over",i))),f=c.subscribe((i=>i&&this.emit("leave",i))),b=u.subscribe((i=>i&&this.emit("dblclick",i))),E=v.subscribe((i=>i&&this.toggleCursor(!0))),C=p.subscribe((i=>i&&this.toggleCursor(!1)));this.subscriptions.push((()=>{g(),m(),f(),b(),E(),C(),l(n),l(s),l(c),l(u),l(v),l(p)}));const L=h(i),y=r((()=>{const i=L.signal.value;i&&("start"===i.type?this.toggleCursor(!0):"move"===i.type&&void 0!==i.deltaX?this.onMove(i.deltaX):"end"===i.type&&(this.toggleCursor(!1),this.drag&&this.emit("update-end")))}),[L.signal]);this.subscriptions.push((()=>{y(),L.cleanup()})),this.contentEditable&&this.content&&(this.contentClickListener=i=>this.onContentClick(i),this.contentBlurListener=()=>this.onContentBlur(),this.content.addEventListener("click",this.contentClickListener),this.content.addEventListener("blur",this.contentBlurListener))}_onUpdate(i,n,s){var r;if(!(null===(r=this.element)||void 0===r?void 0:r.parentElement))return;const{width:o}=this.element.parentElement.getBoundingClientRect(),l=i/o*this.totalDuration;let h=n&&"start"!==n?this.start:this.start+l,c=n&&"end"!==n?this.end:this.end+l;const u=void 0!==s;u&&this.updatingSide&&this.updatingSide!==n&&("start"===this.updatingSide?h=s:c=s),h=Math.max(0,h),c=Math.min(this.totalDuration,c);const v=c-h;this.updatingSide=n;const p=v>=this.minLength&&v<=this.maxLength;h<=c&&(p||u)&&(this.start=h,this.end=c,this.renderPosition(),this.emit("update",n))}onMove(i){this.drag&&this._onUpdate(i)}onResize(i,n){this.resize&&(this.resizeStart||"start"!==n)&&(this.resizeEnd||"end"!==n)&&this._onUpdate(i,n)}onEndResizing(i){this.resize&&(this.emit("update-end",i),this.updatingSide=void 0)}onContentClick(i){i.stopPropagation();i.target.focus(),this.emit("click",i)}onContentBlur(){this.emit("update-end")}_setTotalDuration(i){this.totalDuration=i,this.renderPosition()}play(i){this.emit("play",i&&this.end!==this.start?this.end:void 0)}getContent(i=!1){var n;return i?this.content||void 0:this.element instanceof HTMLElement?(null===(n=this.content)||void 0===n?void 0:n.innerHTML)||void 0:""}setContent(i){var s;if(this.element)if(this.content&&this.contentEditable&&(this.contentClickListener&&this.content.removeEventListener("click",this.contentClickListener),this.contentBlurListener&&this.content.removeEventListener("blur",this.contentBlurListener)),null===(s=this.content)||void 0===s||s.remove(),i){if("string"==typeof i){const s=this.start===this.end;this.content=n("div",{style:{padding:`0.2em ${s?.2:.4}em`,display:"inline-block"},textContent:i})}else this.content=i;this.contentEditable&&(this.content.contentEditable="true",this.contentClickListener=i=>this.onContentClick(i),this.contentBlurListener=()=>this.onContentBlur(),this.content.addEventListener("click",this.contentClickListener),this.content.addEventListener("blur",this.contentBlurListener)),this.content.setAttribute("part","region-content"),this.element.appendChild(this.content),this.emit("content-changed")}else this.content=void 0}setOptions(i){var n,s;if(this.element){if(i.color&&(this.color=i.color,this.element.style.backgroundColor=this.color),void 0!==i.drag&&(this.drag=i.drag,this.element.style.cursor=this.drag?"grab":"default"),void 0!==i.start||void 0!==i.end){const r=this.start===this.end;this.start=this.clampPosition(null!==(n=i.start)&&void 0!==n?n:this.start),this.end=this.clampPosition(null!==(s=i.end)&&void 0!==s?s:r?this.start:this.end),this.renderPosition(),this.setPart()}if(i.content&&this.setContent(i.content),i.id&&(this.id=i.id,this.setPart()),void 0!==i.resize&&i.resize!==this.resize){const n=this.start===this.end;this.resize=i.resize,this.resize&&!n?this.addResizeHandles(this.element):this.removeResizeHandles(this.element)}void 0!==i.resizeStart&&(this.resizeStart=i.resizeStart),void 0!==i.resizeEnd&&(this.resizeEnd=i.resizeEnd)}}remove(){this.isRemoved=!0,this.emit("remove"),this.subscriptions.forEach((i=>i())),this.subscriptions=[],this.content&&this.contentEditable&&(this.contentClickListener&&(this.content.removeEventListener("click",this.contentClickListener),this.contentClickListener=void 0),this.contentBlurListener&&(this.content.removeEventListener("blur",this.contentBlurListener),this.contentBlurListener=void 0)),this.element&&(this.element.remove(),this.element=null),this.unAll()}}class d extends e{constructor(i){super(i),this.regions=[],this.regionsContainer=this.initRegionsContainer()}static create(i){return new d(i)}onInit(){if(!this.wavesurfer)throw Error("WaveSurfer is not initialized");this.wavesurfer.getWrapper().appendChild(this.regionsContainer),this.subscriptions.push(this.wavesurfer.on("ready",(i=>{this.regions.forEach((n=>n._setTotalDuration(i)))})));let i=[];this.subscriptions.push(this.wavesurfer.on("timeupdate",(n=>{const s=this.regions.filter((i=>i.start<=n&&(i.end===i.start?i.start+.05:i.end)>=n));s.forEach((n=>{i.includes(n)||this.emit("region-in",n)})),i.forEach((i=>{s.includes(i)||this.emit("region-out",i)})),i=s})))}initRegionsContainer(){return n("div",{part:"regions-container",style:{position:"absolute",top:"0",left:"0",width:"100%",height:"100%",zIndex:"5",pointerEvents:"none"}})}getRegions(){return this.regions}avoidOverlapping(i){i.content&&setTimeout((()=>{const n=i.content,s=n.getBoundingClientRect(),r=this.regions.map((n=>{if(n===i||!n.content)return 0;const r=n.content.getBoundingClientRect();return s.left<r.left+r.width&&r.left<s.left+s.width?r.height:0})).reduce(((i,n)=>i+n),0);n.style.marginTop=`${r}px`}),10)}adjustScroll(i){var n,s;if(!i.element)return;const r=null===(s=null===(n=this.wavesurfer)||void 0===n?void 0:n.getWrapper())||void 0===s?void 0:s.parentElement;if(!r)return;const{clientWidth:o,scrollWidth:l}=r;if(l<=o)return;const h=r.getBoundingClientRect(),c=i.element.getBoundingClientRect(),u=c.left-h.left,v=c.right-h.left;u<0?r.scrollLeft+=u:v>o&&(r.scrollLeft+=v-o)}virtualAppend(i,n,s){const r=()=>{if(!this.wavesurfer)return;const r=this.wavesurfer.getWidth(),o=this.wavesurfer.getScroll(),l=n.clientWidth,h=this.wavesurfer.getDuration(),c=Math.round(i.start/h*l),u=c+(Math.round((i.end-i.start)/h*l)||1)>o&&c<o+r;u&&!s.parentElement?n.appendChild(s):!u&&s.parentElement&&s.remove()};setTimeout((()=>{if(!this.wavesurfer||!i.element)return;r();const n=this.wavesurfer.on("scroll",r),s=this.wavesurfer.on("zoom",r),o=this.wavesurfer.on("resize",r);this.subscriptions.push(n,s,o),i.once("remove",(()=>{n(),s(),o()}))}),0)}saveRegion(i){if(!i.element)return;this.virtualAppend(i,this.regionsContainer,i.element),this.avoidOverlapping(i),this.regions.push(i);const n=[i.on("update",(n=>{n||this.adjustScroll(i),this.emit("region-update",i,n)})),i.on("update-end",(n=>{this.avoidOverlapping(i),this.emit("region-updated",i,n)})),i.on("play",(n=>{var s;null===(s=this.wavesurfer)||void 0===s||s.play(i.start,n)})),i.on("click",(n=>{this.emit("region-clicked",i,n)})),i.on("dblclick",(n=>{this.emit("region-double-clicked",i,n)})),i.on("content-changed",(()=>{this.emit("region-content-changed",i)})),i.once("remove",(()=>{n.forEach((i=>i())),this.regions=this.regions.filter((n=>n!==i)),this.emit("region-removed",i)}))];this.subscriptions.push(...n),this.emit("region-created",i)}addRegion(i){var n,s;if(!this.wavesurfer)throw Error("WaveSurfer is not initialized");const r=this.wavesurfer.getDuration(),o=null===(s=null===(n=this.wavesurfer)||void 0===n?void 0:n.getDecodedData())||void 0===s?void 0:s.numberOfChannels,l=new a(i,r,o);return this.emit("region-initialized",l),r?this.saveRegion(l):this.subscriptions.push(this.wavesurfer.once("ready",(i=>{l._setTotalDuration(i),this.saveRegion(l)}))),l}enableDragSelection(i,n=3){var s;const o=null===(s=this.wavesurfer)||void 0===s?void 0:s.getWrapper();if(!(o&&o instanceof HTMLElement))return()=>{};let l=null,c=0,u=0;const v=h(o,{threshold:n}),p=r((()=>{var n,s;const r=v.signal.value;if(r)if("start"===r.type){if(c=r.x,!this.wavesurfer)return;const o=this.wavesurfer.getDuration(),h=null===(s=null===(n=this.wavesurfer)||void 0===n?void 0:n.getDecodedData())||void 0===s?void 0:s.numberOfChannels,{width:v}=this.wavesurfer.getWrapper().getBoundingClientRect();u=c/v*o;const p=r.x/v*o,g=(r.x+5)/v*o;l=new a(Object.assign(Object.assign({},i),{start:p,end:g}),o,h),this.emit("region-initialized",l),l.element&&this.regionsContainer.appendChild(l.element)}else"move"===r.type&&void 0!==r.deltaX?l&&l._onUpdate(r.deltaX,r.x>c?"end":"start",u):"end"===r.type&&l&&(this.saveRegion(l),l.updatingSide=void 0,l=null)}),[v.signal]);return()=>{p(),v.cleanup()}}clearRegions(){this.regions.slice().forEach((i=>i.remove())),this.regions=[]}destroy(){this.clearRegions(),super.destroy(),this.regionsContainer.remove()}}export{d as default};

